"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.recurseNestedFields = void 0;
const types_1 = require("../config/types");
const populate_1 = require("./populate");
const relationshipPromise_1 = require("./relationshipPromise");
const recurseNestedFields = ({ promises, data, fields, req, payload, overrideAccess = false, depth, currentDepth = 0, showHiddenFields, }) => {
    fields.forEach((field) => {
        var _a, _b;
        if (field.type === 'relationship' || field.type === 'upload') {
            if (field.type === 'relationship') {
                if (field.hasMany && Array.isArray(data[field.name])) {
                    if (Array.isArray(field.relationTo)) {
                        data[field.name].forEach(({ relationTo, value }, i) => {
                            const collection = payload.collections[relationTo];
                            if (collection) {
                                promises.push((0, populate_1.populate)({
                                    id: value,
                                    field,
                                    collection,
                                    data: data[field.name],
                                    key: i,
                                    overrideAccess,
                                    depth,
                                    currentDepth,
                                    payload,
                                    req,
                                    showHiddenFields,
                                }));
                            }
                        });
                    }
                    else {
                        data[field.name].forEach((id, i) => {
                            const collection = payload.collections[field.relationTo];
                            if (collection) {
                                promises.push((0, populate_1.populate)({
                                    id,
                                    field,
                                    collection,
                                    data: data[field.name],
                                    key: i,
                                    overrideAccess,
                                    depth,
                                    currentDepth,
                                    payload,
                                    req,
                                    showHiddenFields,
                                }));
                            }
                        });
                    }
                }
                else if (Array.isArray(field.relationTo) && ((_a = data[field.name]) === null || _a === void 0 ? void 0 : _a.value) && ((_b = data[field.name]) === null || _b === void 0 ? void 0 : _b.relationTo)) {
                    const collection = payload.collections[data[field.name].relationTo];
                    promises.push((0, populate_1.populate)({
                        id: data[field.name].value,
                        field,
                        collection,
                        data: data[field.name],
                        key: 'value',
                        overrideAccess,
                        depth,
                        currentDepth,
                        payload,
                        req,
                        showHiddenFields,
                    }));
                }
            }
            if (typeof data[field.name] !== 'undefined' && typeof field.relationTo === 'string') {
                const collection = payload.collections[field.relationTo];
                promises.push((0, populate_1.populate)({
                    id: data[field.name],
                    field,
                    collection,
                    data,
                    key: field.name,
                    overrideAccess,
                    depth,
                    currentDepth,
                    payload,
                    req,
                    showHiddenFields,
                }));
            }
        }
        else if ((0, types_1.fieldHasSubFields)(field) && !(0, types_1.fieldIsArrayType)(field)) {
            if ((0, types_1.fieldAffectsData)(field) && typeof data[field.name] === 'object') {
                (0, exports.recurseNestedFields)({
                    promises,
                    data: data[field.name],
                    fields: field.fields,
                    req,
                    payload,
                    overrideAccess,
                    depth,
                    currentDepth,
                    showHiddenFields,
                });
            }
            else {
                (0, exports.recurseNestedFields)({
                    promises,
                    data,
                    fields: field.fields,
                    req,
                    payload,
                    overrideAccess,
                    depth,
                    currentDepth,
                    showHiddenFields,
                });
            }
        }
        else if (Array.isArray(data[field.name])) {
            if (field.type === 'blocks') {
                data[field.name].forEach((row, i) => {
                    const block = field.blocks.find(({ slug }) => slug === (row === null || row === void 0 ? void 0 : row.blockType));
                    if (block) {
                        (0, exports.recurseNestedFields)({
                            promises,
                            data: data[field.name][i],
                            fields: block.fields,
                            req,
                            payload,
                            overrideAccess,
                            depth,
                            currentDepth,
                            showHiddenFields,
                        });
                    }
                });
            }
            if (field.type === 'array') {
                data[field.name].forEach((_, i) => {
                    (0, exports.recurseNestedFields)({
                        promises,
                        data: data[field.name][i],
                        fields: field.fields,
                        req,
                        payload,
                        overrideAccess,
                        depth,
                        currentDepth,
                        showHiddenFields,
                    });
                });
            }
        }
        if (field.type === 'richText' && Array.isArray(data[field.name])) {
            data[field.name].forEach((node) => {
                if (Array.isArray(node.children)) {
                    (0, relationshipPromise_1.recurseRichText)({
                        req,
                        children: node.children,
                        payload,
                        overrideAccess,
                        depth,
                        currentDepth,
                        field,
                        promises,
                        showHiddenFields,
                    });
                }
            });
        }
    });
};
exports.recurseNestedFields = recurseNestedFields;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVjdXJzZU5lc3RlZEZpZWxkcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9maWVsZHMvcmljaFRleHQvcmVjdXJzZU5lc3RlZEZpZWxkcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSwyQ0FBK0Y7QUFFL0YseUNBQXNDO0FBQ3RDLCtEQUF3RDtBQWNqRCxNQUFNLG1CQUFtQixHQUFHLENBQUMsRUFDbEMsUUFBUSxFQUNSLElBQUksRUFDSixNQUFNLEVBQ04sR0FBRyxFQUNILE9BQU8sRUFDUCxjQUFjLEdBQUcsS0FBSyxFQUN0QixLQUFLLEVBQ0wsWUFBWSxHQUFHLENBQUMsRUFDaEIsZ0JBQWdCLEdBQ1MsRUFBUSxFQUFFO0lBQ25DLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTs7UUFDdkIsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLGNBQWMsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRTtZQUM1RCxJQUFJLEtBQUssQ0FBQyxJQUFJLEtBQUssY0FBYyxFQUFFO2dCQUNqQyxJQUFJLEtBQUssQ0FBQyxPQUFPLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUU7b0JBQ3BELElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLEVBQUU7d0JBQ25DLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUU7NEJBQ3BELE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUM7NEJBQ25ELElBQUksVUFBVSxFQUFFO2dDQUNkLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBQSxtQkFBUSxFQUFDO29DQUNyQixFQUFFLEVBQUUsS0FBSztvQ0FDVCxLQUFLO29DQUNMLFVBQVU7b0NBQ1YsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDO29DQUN0QixHQUFHLEVBQUUsQ0FBQztvQ0FDTixjQUFjO29DQUNkLEtBQUs7b0NBQ0wsWUFBWTtvQ0FDWixPQUFPO29DQUNQLEdBQUc7b0NBQ0gsZ0JBQWdCO2lDQUNqQixDQUFDLENBQUMsQ0FBQzs2QkFDTDt3QkFDSCxDQUFDLENBQUMsQ0FBQztxQkFDSjt5QkFBTTt3QkFDTCxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRTs0QkFDakMsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsVUFBb0IsQ0FBQyxDQUFDOzRCQUNuRSxJQUFJLFVBQVUsRUFBRTtnQ0FDZCxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUEsbUJBQVEsRUFBQztvQ0FDckIsRUFBRTtvQ0FDRixLQUFLO29DQUNMLFVBQVU7b0NBQ1YsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDO29DQUN0QixHQUFHLEVBQUUsQ0FBQztvQ0FDTixjQUFjO29DQUNkLEtBQUs7b0NBQ0wsWUFBWTtvQ0FDWixPQUFPO29DQUNQLEdBQUc7b0NBQ0gsZ0JBQWdCO2lDQUNqQixDQUFDLENBQUMsQ0FBQzs2QkFDTDt3QkFDSCxDQUFDLENBQUMsQ0FBQztxQkFDSjtpQkFDRjtxQkFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxLQUFJLE1BQUEsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsMENBQUUsS0FBSyxDQUFBLEtBQUksTUFBQSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQywwQ0FBRSxVQUFVLENBQUEsRUFBRTtvQkFDckcsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDO29CQUNwRSxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUEsbUJBQVEsRUFBQzt3QkFDckIsRUFBRSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSzt3QkFDMUIsS0FBSzt3QkFDTCxVQUFVO3dCQUNWLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQzt3QkFDdEIsR0FBRyxFQUFFLE9BQU87d0JBQ1osY0FBYzt3QkFDZCxLQUFLO3dCQUNMLFlBQVk7d0JBQ1osT0FBTzt3QkFDUCxHQUFHO3dCQUNILGdCQUFnQjtxQkFDakIsQ0FBQyxDQUFDLENBQUM7aUJBQ0w7YUFDRjtZQUNELElBQUksT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLFdBQVcsSUFBSSxPQUFPLEtBQUssQ0FBQyxVQUFVLEtBQUssUUFBUSxFQUFFO2dCQUNuRixNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDekQsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFBLG1CQUFRLEVBQUM7b0JBQ3JCLEVBQUUsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztvQkFDcEIsS0FBSztvQkFDTCxVQUFVO29CQUNWLElBQUk7b0JBQ0osR0FBRyxFQUFFLEtBQUssQ0FBQyxJQUFJO29CQUNmLGNBQWM7b0JBQ2QsS0FBSztvQkFDTCxZQUFZO29CQUNaLE9BQU87b0JBQ1AsR0FBRztvQkFDSCxnQkFBZ0I7aUJBQ2pCLENBQUMsQ0FBQyxDQUFDO2FBQ0w7U0FDRjthQUFNLElBQUksSUFBQSx5QkFBaUIsRUFBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUEsd0JBQWdCLEVBQUMsS0FBSyxDQUFDLEVBQUU7WUFDL0QsSUFBSSxJQUFBLHdCQUFnQixFQUFDLEtBQUssQ0FBQyxJQUFJLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxRQUFRLEVBQUU7Z0JBQ25FLElBQUEsMkJBQW1CLEVBQUM7b0JBQ2xCLFFBQVE7b0JBQ1IsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDO29CQUN0QixNQUFNLEVBQUUsS0FBSyxDQUFDLE1BQU07b0JBQ3BCLEdBQUc7b0JBQ0gsT0FBTztvQkFDUCxjQUFjO29CQUNkLEtBQUs7b0JBQ0wsWUFBWTtvQkFDWixnQkFBZ0I7aUJBQ2pCLENBQUMsQ0FBQzthQUNKO2lCQUFNO2dCQUNMLElBQUEsMkJBQW1CLEVBQUM7b0JBQ2xCLFFBQVE7b0JBQ1IsSUFBSTtvQkFDSixNQUFNLEVBQUUsS0FBSyxDQUFDLE1BQU07b0JBQ3BCLEdBQUc7b0JBQ0gsT0FBTztvQkFDUCxjQUFjO29CQUNkLEtBQUs7b0JBQ0wsWUFBWTtvQkFDWixnQkFBZ0I7aUJBQ2pCLENBQUMsQ0FBQzthQUNKO1NBQ0Y7YUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFO1lBQzFDLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxRQUFRLEVBQUU7Z0JBQzNCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUNsQyxNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUFDLElBQUksTUFBSyxHQUFHLGFBQUgsR0FBRyx1QkFBSCxHQUFHLENBQUUsU0FBUyxDQUFBLENBQUMsQ0FBQztvQkFDdkUsSUFBSSxLQUFLLEVBQUU7d0JBQ1QsSUFBQSwyQkFBbUIsRUFBQzs0QkFDbEIsUUFBUTs0QkFDUixJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7NEJBQ3pCLE1BQU0sRUFBRSxLQUFLLENBQUMsTUFBTTs0QkFDcEIsR0FBRzs0QkFDSCxPQUFPOzRCQUNQLGNBQWM7NEJBQ2QsS0FBSzs0QkFDTCxZQUFZOzRCQUNaLGdCQUFnQjt5QkFDakIsQ0FBQyxDQUFDO3FCQUNKO2dCQUNILENBQUMsQ0FBQyxDQUFDO2FBQ0o7WUFFRCxJQUFJLEtBQUssQ0FBQyxJQUFJLEtBQUssT0FBTyxFQUFFO2dCQUMxQixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtvQkFDaEMsSUFBQSwyQkFBbUIsRUFBQzt3QkFDbEIsUUFBUTt3QkFDUixJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ3pCLE1BQU0sRUFBRSxLQUFLLENBQUMsTUFBTTt3QkFDcEIsR0FBRzt3QkFDSCxPQUFPO3dCQUNQLGNBQWM7d0JBQ2QsS0FBSzt3QkFDTCxZQUFZO3dCQUNaLGdCQUFnQjtxQkFDakIsQ0FBQyxDQUFDO2dCQUNMLENBQUMsQ0FBQyxDQUFDO2FBQ0o7U0FDRjtRQUVELElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxVQUFVLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUU7WUFDaEUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtnQkFDaEMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRTtvQkFDaEMsSUFBQSxxQ0FBZSxFQUFDO3dCQUNkLEdBQUc7d0JBQ0gsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO3dCQUN2QixPQUFPO3dCQUNQLGNBQWM7d0JBQ2QsS0FBSzt3QkFDTCxZQUFZO3dCQUNaLEtBQUs7d0JBQ0wsUUFBUTt3QkFDUixnQkFBZ0I7cUJBQ2pCLENBQUMsQ0FBQztpQkFDSjtZQUNILENBQUMsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQztBQXhLVyxRQUFBLG1CQUFtQix1QkF3SzlCIn0=